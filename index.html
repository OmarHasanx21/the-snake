<!DOCTYPE html>
<html>
    <head><meta charset="UTF-8">
        <title>The Snake</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
<script src="https://www.gstatic.com/firebasejs/3.6.6/firebase.js"></script>
        <link rel="stylesheet" href="css.css">

 </head>
<body id='bdy'>
    <div id='fc'>
        <div class="game-info">
            <div id='fpsc'>0 FPS</div>
            <div id='score'>Lvl 0 Score </br>0</div>
            <div id='leng'>Length </br>0</div>
        </div>

        <canvas id='canvas1'></canvas>
        <div id='pbutton'>Pause</div>

        <div class="controls-container">
            <button id='upb' class='control-button'>Up</button>
            <button id='leftb' class='control-button'>Left</button>
            <button id='downb' class='control-button'>Down</button>
            <button id='rightb' class='control-button'>Right</button>
        </div>
    </div>

    <div id='sets'>
        <h2>Settings</h2>

        <div class="setting-group">
            <label for="colorstyle">Snake Color Style</label>
            <select id='colorstyle'>
                <option>1 Color</option>
                <option>Random Color When Eating Food</option>
                <option>Random Color Every Move</option>
                <option>Random Color On Click</option>
                <option>Random Color Every Frame</option>
            </select>
        </div>
        <div class="setting-group">
            <label for="selectcolor">Snake Color</label>
            <input type='color' id='selectcolor' value='#9910ff'>
        </div>

        <div class="setting-group">
            <label for="sstyle-select">Snake Style</label>
            <select id='sstyle-select'>
                <option>Boxes</option>
                <option>Normal</option>
                <option>Circle</option>
            </select>
        </div>

        <hr id="sline">

        <div class="setting-group">
            <label for="fcsse">Food Color Style</label>
            <select id='fcsse'>
                <option>Color</option>
                <option>Random Color</option>
                <option>Random Color Every Frame</option>
                <option>Same As The Snake</option>
            </select>
        </div>
        <div class="setting-group">
            <label for="fce">Food Color</label>
            <input type='color' id='fce' value='#9010ff'>
        </div>

        <button id='startb'>Apply</button>
    </div>

    <script type='text/javascript'>
(function() { // IIFE to avoid global scope pollution

    // --- DOM Elements ---
    const dom = {
        canvas: document.getElementById('canvas1'),
        fc: document.getElementById('fc'),
        fpsc: document.getElementById('fpsc'),
        leng: document.getElementById('leng'),
        score: document.getElementById('score'),
        pButton: document.getElementById('pbutton'),
        sets: document.getElementById('sets'),
        startB: document.getElementById('startb'),
        leftB: document.getElementById('leftb'),
        upB: document.getElementById('upb'),
        downB: document.getElementById('downb'),
        rightB: document.getElementById('rightb'),
        colorStyle: document.getElementById('colorstyle'),
        selectColor: document.getElementById('selectcolor'),
        sstyleSelect: document.getElementById('sstyle-select'),
        fcsse: document.getElementById('fcsse'),
        fce: document.getElementById('fce')
    };

    const ctx = dom.canvas.getContext('2d');

    // --- Game State and Settings ---
    const game = {
        snake: {
            body: [],
            sclx: 0,
            scly: 0,
            r: 0,
            speedX: 0,
            speedY: 0,
            shape: 'box',
            color: '#9910ff',
        },
        food: {
            x: 0,
            y: 0,
            sclx: 0,
            scly: 0,
            color: '#9010ff',
        },
        score: 0,
        level: 0,
        moveSpeed: 250,
        initialMoveSpeed: 250,
        direction: 'right',
        lastDirection: 'right',
        paused: true,
        gameOver: true,
        settings: {
            colorStyle: '1 Color',
            foodColorStyle: 'Color',
            snakeStyle: 'Boxes',
            frameRate: 10, // for color updates
        },
        intervals: {
            move: null,
            color: null,
            foodColor: null
        },
        progressLevels: []
    };

    // --- Constants ---
    const INITIAL_SNAKE_LENGTH = 4;
    const SNAKE_SPEED_X_BOX = 4.1;
    const SNAKE_SPEED_Y_BOX = 4.0; // This is unused, can be removed
    const PI_2 = Math.PI * 2;


    // --- Utility Functions ---
    function ptp(type, value) { // Percentage To Pixels
        // Now based on the canvas size for more reliable positioning
        const width = dom.canvas.width;
        const height = dom.canvas.height;
        switch (type) {
            case 0: return (width / 100) * value;
            case 1: return (height / 100) * value;
            case 2: return ((width + height) / 2 / 100) * value;
            default: return 0;
        }
    }

    function rn(min, max) {
        return Math.floor(Math.random() * (max - min)) + min;
    }

    function randomColor() {
        return `rgb(${rn(40, 255)},${rn(40, 255)},${rn(40, 255)})`;
    }


    // --- Game Setup and Initialization ---
    function initSnake() {
        game.snake.body = [];
        const startX = ptp(0, 20);
        const startY = ptp(1, 50); // Center vertically
        game.snake.sclx = ptp(0, 3.8);

        for (let i = 0; i < INITIAL_SNAKE_LENGTH; i++) {
            game.snake.body.push({
                x: startX - (i * game.snake.sclx),
                y: startY
            });
        }
    }

    function calculateProgressLevels() {
        let levels = 75;
        let lp = 1;
        for (let i = 0; i < 50; i++) {
            game.progressLevels[i] = levels;
            lp += 2;
            levels += 75 + lp;
        }
    }

    function resetGame() {
        game.gameOver = false;
        game.paused = true;
        game.score = 0;
        game.level = 0;
        game.moveSpeed = game.initialMoveSpeed;
        game.direction = 'right';
        game.lastDirection = 'right';
        
        initSnake();
        spawnFood();
        updateUI();

        dom.pButton.style.visibility = 'hidden';
        dom.sets.style.visibility = 'visible';
        dom.pButton.innerHTML = 'Play';
    }

    // --- Drawing ---
    function draw() {
        ctx.clearRect(0, 0, dom.canvas.width, dom.canvas.height);
        
        // Draw Food
        ctx.fillStyle = game.food.color;
        ctx.shadowColor = game.food.color;
        ctx.shadowBlur = 15;
        ctx.fillRect(game.food.x, game.food.y, game.food.sclx, game.food.scly);
        
        // Draw Snake
        ctx.fillStyle = game.snake.color;
        ctx.shadowBlur = 0;
        game.snake.body.forEach(segment => {
            ctx.beginPath();
            if (game.snake.shape === 'circle') {
                ctx.arc(segment.x + game.snake.r, segment.y + game.snake.r, game.snake.r, 0, PI_2);
            } else {
                ctx.rect(segment.x, segment.y, game.snake.sclx, game.snake.scly);
            }
            ctx.fill();
        });
    }

    // --- Game Logic ---
    function spawnFood() {
        let validPosition = false;
        let x, y, sclx, scly;

        while (!validPosition) {
            validPosition = true;
            // Align food to the same grid as the snake
            x = Math.floor(rn(0, dom.canvas.width / game.snake.sclx)) * game.snake.sclx;
            y = Math.floor(rn(0, dom.canvas.height / game.snake.scly)) * game.snake.scly;
            sclx = game.snake.sclx;
            scly = sclx; // Keep food square

            // Check if food spawns on the snake
            for (const segment of game.snake.body) {
                if (x < segment.x + game.snake.sclx && x + sclx > segment.x &&
                    y < segment.y + game.snake.scly && y + scly > segment.y) {
                    validPosition = false;
                    break;
                }
            }
        }
        game.food = { x, y, sclx, scly, color: game.food.color };
    }
    
    function moveSnake() {
        if (game.paused || game.gameOver) return;

        const head = { x: game.snake.body[0].x, y: game.snake.body[0].y };

        const speed = game.snake.sclx; // Move one block at a time

        switch (game.direction) {
            case 'right': head.x += speed; break;
            case 'left': head.x -= speed; break;
            case 'up': head.y -= speed; break;
            case 'down': head.y += speed; break;
        }
        game.lastDirection = game.direction;

        // Wall collision check
        if (head.x < 0 || head.x + game.snake.sclx > dom.canvas.width || head.y < 0 || head.y + game.snake.scly > dom.canvas.height) {
            handleDeath();
            return;
        }
        
        game.snake.body.unshift(head);

        if (head.x < game.food.x + game.food.sclx && head.x + game.snake.sclx > game.food.x &&
            head.y < game.food.y + game.food.scly && head.y + game.snake.scly > game.food.y) { // Food collision
            
            game.score += 10;
            checkProgress();
            spawnFood();
            
            if (game.settings.colorStyle === 'Random Color When Eating Food') game.snake.color = randomColor();
            if (game.settings.foodColorStyle === 'Random Color') game.food.color = randomColor();
        } else {
            game.snake.body.pop();
        }
        
        // Self-collision check
        for (let i = 1; i < game.snake.body.length; i++) {
            if (Math.abs(head.x - game.snake.body[i].x) < 1 && Math.abs(head.y - game.snake.body[i].y) < 1) {
                handleDeath();
                return;
            }
        }

        if (game.settings.colorStyle === 'Random Color Every Move') game.snake.color = randomColor();
        updateUI();
    }
    
    function handleDeath() {
        game.gameOver = true;
        game.paused = true;
        stopGameLoop();
        alert(`Game Over!\nYour Score: ${Math.round(game.score)}`);
        resetGame();
    }
    
    function checkProgress() {
        if (game.score > game.progressLevels[game.level]) {
            game.moveSpeed = Math.max(50, game.moveSpeed - 10); // Speed up, with a max speed
            game.level++;
            startGameLoop(); // Restart with new speed
        }
    }

    // --- UI and Event Handlers ---
    function updateUI() {
        dom.leng.innerHTML = `Length </br>${game.snake.body.length}`;
        dom.score.innerHTML = `Lvl ${game.level} Score </br>${Math.round(game.score)}`;
    }
    
    function changeDirection(newDir) {
        const opposite = { 'left': 'right', 'right': 'left', 'up': 'down', 'down': 'up' };
        if (!game.paused && newDir !== opposite[game.lastDirection]) {
            game.direction = newDir;
            if (game.settings.colorStyle === 'Random Color On Click') game.snake.color = randomColor();
        }
    }

    function togglePause() {
        if(game.gameOver) {
            applySettings();
            return;
        }
        
        game.paused = !game.paused;
        if (game.paused) {
            dom.pButton.innerHTML = 'Resume';
            dom.sets.style.visibility = 'visible';
        } else {
            // If resuming without applying settings, just hide the menu
            applySettings(); // Apply settings also handles resuming
            dom.sets.style.visibility = 'hidden';
            dom.pButton.innerHTML = 'Pause'; 
        }
    }

    function applySettings() {
        game.settings.colorStyle = dom.colorStyle.value;
        clearInterval(game.intervals.color);
        if (game.settings.colorStyle === '1 Color') game.snake.color = dom.selectColor.value;
        else if (game.settings.colorStyle === 'Random Color Every Frame') {
            game.intervals.color = setInterval(() => game.snake.color = randomColor(), game.settings.frameRate);
        }

        game.settings.snakeStyle = dom.sstyleSelect.value;
        game.snake.shape = (game.settings.snakeStyle === 'Circle') ? 'circle' : 'box';

        game.settings.foodColorStyle = dom.fcsse.value;
        clearInterval(game.intervals.foodColor);
        if(game.settings.foodColorStyle === 'Color') game.food.color = dom.fce.value;
        else if (game.settings.foodColorStyle === 'Same As The Snake') {
            game.intervals.foodColor = setInterval(() => game.food.color = game.snake.color, game.settings.frameRate);
        } else if (game.settings.foodColorStyle === 'Random Color Every Frame') {
            game.intervals.foodColor = setInterval(() => game.food.color = randomColor(), game.settings.frameRate);
        }
        
        dom.sets.style.visibility = 'hidden';
        if (game.gameOver || game.paused) {
            game.gameOver = false;
            game.paused = false;
            startGameLoop();
            dom.pButton.innerHTML = 'Pause';
        }
        dom.pButton.style.visibility = 'visible';
    }
    
    function handleResize() {
        // Set logical size
        const logicalWidth = 800;
        const logicalHeight = 600;

        dom.canvas.width = logicalWidth;
        dom.canvas.height = logicalHeight;

        // Scale visually
        const container = dom.fc.parentElement; // Use the main body for aspect ratio scaling
        const ratio = logicalWidth / logicalHeight;
        
        let newWidth = container.clientWidth;
        let newHeight = container.clientHeight;

        if (newWidth / newHeight > ratio) {
            newWidth = newHeight * ratio;
        } else {
            newHeight = newWidth / ratio;
        }
        
        dom.fc.style.width = `${newWidth}px`;
        dom.fc.style.height = `${newHeight}px`;

        // Recalculate game element sizes based on new logical canvas size
        game.snake.sclx = ptp(0, 3.8);
        game.snake.scly = game.snake.sclx; // Keep snake blocks square
        game.snake.r = game.snake.sclx / 2;

        draw(); // Redraw with new sizes
    }

    // --- Main Loop ---
    let lastFrameTime = 0;
    let fps = 0;
    function gameLoop(timestamp) {
        // Calculate FPS
        if (timestamp - lastFrameTime >= 500) {
            dom.fpsc.innerHTML = `${fps * 2} FPS`;
            fps = 0;
            lastFrameTime = timestamp;
        }
        fps++;

        if (!game.paused) {
            draw();
        }
        requestAnimationFrame(gameLoop);
    }
    
    function startGameLoop() {
        clearInterval(game.intervals.move);
        game.intervals.move = setInterval(moveSnake, game.moveSpeed);
    }

    function stopGameLoop() {
        clearInterval(game.intervals.move);
    }


    // --- Initialization ---
    function init() {
        ['left', 'up', 'down', 'right'].forEach(dir => {
            document.getElementById(`${dir}b`).addEventListener('click', () => changeDirection(dir));
        });
        
        window.addEventListener('keydown', e => {
            const keyMap = { 'ArrowUp': 'up', 'w': 'up', 'ArrowDown': 'down', 's': 'down', 'ArrowLeft': 'left', 'a': 'left', 'ArrowRight': 'right', 'd': 'right' };
            if(keyMap[e.key]) {
                e.preventDefault(); // Prevent arrow keys from scrolling the page
                changeDirection(keyMap[e.key]);
            }
        });

        dom.pButton.addEventListener('click', togglePause);
        dom.startB.addEventListener('click', applySettings);
        window.addEventListener('resize', handleResize);

        handleResize(); // Initial size calculation
        calculateProgressLevels();
        resetGame();
        requestAnimationFrame(gameLoop);
    }

    window.addEventListener('load', init);

})();
 </script>
</body>
</html>